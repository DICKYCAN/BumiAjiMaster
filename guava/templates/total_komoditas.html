{% extends "base/base.html" %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Rekap Komoditas</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        select { margin-right: 10px; }
    </style>
</head>
<body>

    <h1>Rekap Komoditas Masuk</h1>

    <div>
        <label for="filter-komoditas">Filter Komoditas:</label>
    <select id="filter-komoditas">
        <option value="">Semua</option>
        {% for komoditas in komoditas_list %}
            <option value="{{ komoditas }}">{{ komoditas }}</option>
        {% endfor %}
    </select>

    <label for="filter-tanggal">Filter Tanggal:</label>
    <select id="filter-tanggal">
        <option value="">Semua</option>
        {% for tanggal in tanggal_list %}
            <option value="{{ tanggal }}">{{ tanggal }}</option>
        {% endfor %}
    </select>
    </div>

    <div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="datatotal">
                        <thead class="table-light">
                            <tr>
                                <th>Komoditas</th>
                                <th>Grade</th>
                                <th>tanggal panen</th>
                                <th>batch</th>
                                <th>Tanggal Kadaluwarsa</th>
                                <th>Total Kuantitas</th>
                                <th>Data QR</th>
                            </tr>
                        </thead>
                        <tbody class="table-dark">
                            {% for item in list_total %}
                            <tr data-komoditas="{{ item.komoditas }}"
                                data-grade="{{ item.grade }}"
                                data-tanggal="{{ item.tanggal_kadaluwarsa }}">
                                <td>{{ item.komoditas }}</td>
                                <td>{{ item.grade }}</td>
                                <td>{{ item.tanggal_panen }}</td>
                                <td>{{ item.batch }}</td>
                                <td>{{ item.tanggal_kadaluwarsa }}</td>
                                <td>{{ item.total_kuantitas }}</td>
                                <td>
                                    <button class="btn btn-primary btn-download-qr"
                                        data-komoditas="{{ item.komoditas }}"
                                        data-kadaluarsa="{{ item.tanggal_kadaluwarsa }}"
                                        data-kuantitas="{{ item.total_kuantitas }}">
                                        Download QR
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const filterKomoditas = document.getElementById("filter-komoditas");
        const filterTanggal = document.getElementById("filter-tanggal");
        const rows = document.querySelectorAll("#datatotal tbody tr");

        function applyFilter() {
            const komoditas = filterKomoditas.value;
            const tanggal = filterTanggal.value;

            rows.forEach(row => {
                const matchKomoditas = !komoditas || row.dataset.komoditas === komoditas;
                const matchTanggal = !tanggal || row.dataset.tanggal === tanggal;

                row.style.display = (matchKomoditas && matchGrade && matchTanggal) ? "" : "none";
            });
        }

        filterKomoditas.addEventListener("change", applyFilter);
        filterTanggal.addEventListener("change", applyFilter);
    </script>
    <script>
        document.querySelectorAll(".btn-download-qr").forEach(btn => {
            btn.addEventListener("click", () => {
                const komoditas = btn.dataset.komoditas;
                const kadaluarsa = btn.dataset.kadaluarsa;
                const kuantitas = btn.dataset.kuantitas;

                const qrData = `${komoditas}|${kadaluarsa}|${kuantitas}`;

                // Generate QR sebagai canvas
                QRCode.toCanvas(qrData, { width: 200 }, function (err, canvas) {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    // Convert canvas ke data URL
                    const link = document.createElement("a");
                    link.href = canvas.toDataURL("image/png");
                    link.download = `QR_${komoditas}_${kadaluarsa}.png`;
                    link.click();
                });
            });
        });
    </script>
    <script>
        // Ambil semua baris
        const tbody = document.querySelector("#datatotal tbody");
        const rowsArray = Array.from(tbody.querySelectorAll("tr"));

        // Sort berdasarkan tanggal kadaluarsa (data-tanggal)
        rowsArray.sort((a, b) => {
            const dateA = new Date(a.dataset.tanggal);
            const dateB = new Date(b.dataset.tanggal);
            return dateA - dateB; // ascending: paling baru dulu
        });

        // Masukkan kembali ke tbody
        rowsArray.forEach(row => tbody.appendChild(row));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>


</body>
</html>
{% endblock %}
